{% extends "base.html" %}
{% block title %}{{ meta.label }} | AnÃ¡lise{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<h3 class="mb-3">{{ meta.label }}</h3>

{% if stage == 'form' %}
  <form method="post" class="card p-3 mb-4">
    {% if 'dataset' in meta.params %}
    <div class="mb-3">
      <label class="form-label">Base de dados</label>
      <select name="dataset" class="form-select" required>
        {% for s, t in tables %}
          <option value="{{ t }}">{{ s }} ({{ t }})</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}

    {% if 'crime' in meta.params %}
    <div class="mb-3">
      <label class="form-label">Crime (Natureza)</label>
      <select name="crime" class="form-select" required>
        {% for c in crimes %}
          <option value="{{ c }}">{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}

    {% if 'bairro' in meta.params %}
    <div class="mb-3">
      <label class="form-label">Bairro</label>
      <select name="bairro" class="form-select" required>
        {% for b in bairros %}
          <option value="{{ b }}">{{ b }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}

    {% if 'semestre' in meta.params %}
    <div class="mb-3">
      <label class="form-label">Semestre</label>
      <select name="semestre" class="form-select" required>
        <option value="1">1Âº Semestre</option>
        <option value="2">2Âº Semestre</option>
      </select>
    </div>
    {% endif %}

    {% if 'periodo' in meta.params %}
    <div class="mb-3">
      <label class="form-label">PerÃ­odo do dia</label>
      <select name="periodo" class="form-select" required>
        <option value="ManhÃ£">ManhÃ£</option>
        <option value="Tarde">Tarde</option>
        <option value="Noite">Noite</option>
      </select>
    </div>
    {% endif %}

    <button class="btn btn-primary">Gerar grÃ¡fico</button>
  </form>

{% elif stage == 'chart' %}
  <div class="card p-3 mb-4">
    <h5 class="mb-2">{{ meta.label }}</h5>
    <p class="text-muted small mb-3">
      Base: {{ table_name }} |
      {% for k, v in params.items() if v %}
        {{ k }}: <strong>{{ v }}</strong>{% if not loop.last %} â€¢ {% endif %}
      {% endfor %}
    </p>

    {% if labels and values %}
      <canvas id="chartCanvas" height="120"></canvas>
    {% else %}
      <p class="text-warning">Nenhum dado encontrado para os filtros selecionados.</p>
    {% endif %}
  </div>

  {% if result_table %}
  <div class="card p-3">
    <h6 class="mb-2">ðŸ“‹ Dados Detalhados</h6>
    <div class="table-responsive">
      {{ result_table|safe }}
    </div>
  </div>
  {% endif %}
{% endif %}
{% endblock %}

{% block scripts %}
{% if stage == 'chart' and labels and values %}
<script>
  const ctx = document.getElementById('chartCanvas').getContext('2d');

  // Detecta tipo de grÃ¡fico
  let chartType = 'bar';
  const labelLower = '{{ meta.label }}'.toLowerCase();
  if (labelLower.includes('evoluÃ§Ã£o')) chartType = 'line';
  else if (labelLower.includes('ambiente')) chartType = 'pie';

  new Chart(ctx, {
    type: chartType,
    data: {
      labels: {{ labels|tojson }},
      datasets: [{
        label: '{{ meta.label }}',
        data: {{ values|tojson }},
        borderColor: chartType === 'line' ? '#58a6ff' : '#2ea043',
        backgroundColor: chartType === 'pie'
          ? ['#58a6ff','#2ea043','#f59e0b','#ef4444','#a855f7','#14b8a6','#84cc16','#06b6d4','#ec4899','#9333ea']
          : 'rgba(88,166,255,0.5)',
        borderWidth: 2,
        tension: 0.3,
        fill: chartType === 'line'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: chartType === 'pie' }
      },
      scales: chartType !== 'pie' ? {
        y: { beginAtZero: true, ticks: { color: '#e6edf3' }, grid: { color: '#30363d' }},
        x: { ticks: { color: '#e6edf3' }, grid: { color: '#30363d' }}
      } : {}
    }
  });
</script>
{% endif %}
{% endblock %}
